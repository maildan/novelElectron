// ğŸ”¥ ê¸°ê°€ì°¨ë“œ Loop Typing Analytics - Prisma Schema
// Loop í”„ë¡œì íŠ¸ì˜ íƒ€ì… ì•ˆì „ì„±ì„ ë³´ì¥í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = "file:./loop.db"
}

// ğŸ¯ ì‚¬ìš©ì ëª¨ë¸ - ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions  TypingSession[]
  settings  UserSettings?
  projects  Project[]        // ğŸ”¥ í”„ë¡œì íŠ¸ ê´€ê³„ ì¶”ê°€
  
  @@map("users")
}

// ğŸ“ í”„ë¡œì íŠ¸ ëª¨ë¸ - ì‚¬ìš©ì ë¬¸ì„œ/ê¸€ í”„ë¡œì íŠ¸
model Project {
  id           String   @id @default(cuid())
  title        String
  description  String?
  content      String?  // í”„ë¡œì íŠ¸ ë‚´ìš©
  genre        String   @default("ê¸°íƒ€")
  status       String   @default("active") // 'active' | 'completed' | 'paused'
  progress     Int      @default(0)       // ì§„í–‰ë¥  (0-100)
  wordCount    Int      @default(0)       // ë‹¨ì–´ ìˆ˜
  author       String   @default("ì‚¬ìš©ì")
  platform     String   @default("loop")  // 'loop' | 'google-docs' | 'import'
  userId       String?  // Optional: ë‹¤ì¤‘ ì‚¬ìš©ì ì§€ì› ëŒ€ë¹„
  createdAt    DateTime @default(now())
  lastModified DateTime @updatedAt

  // Relations
  user        User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  characters  ProjectCharacter[]   // ğŸ”¥ ë“±ì¥ì¸ë¬¼ ê´€ê³„
  structure   ProjectStructure[]   // ğŸ”¥ êµ¬ì¡° ê´€ê³„
  notes       ProjectNote[]        // ğŸ”¥ ë©”ëª¨ ê´€ê³„
  
  @@map("projects")
  @@index([userId])
  @@index([status])
  @@index([lastModified])
}

// ğŸ‘¥ í”„ë¡œì íŠ¸ ë“±ì¥ì¸ë¬¼ ëª¨ë¸ - ì‘ê°€ìš© ìºë¦­í„° ê´€ë¦¬
model ProjectCharacter {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  role        String   // 'ì£¼ì¸ê³µ' | 'ì¡°ë ¥ì' | 'ì ëŒ€ì' | 'ì—‘ìŠ¤íŠ¸ë¼'
  description String?  // ìºë¦­í„° ì„¤ëª…
  notes       String?  // ì‘ê°€ ë©”ëª¨
  appearance  String?  // ì™¸ëª¨ ì„¤ëª…
  personality String?  // ì„±ê²©
  background  String?  // ë°°ê²½ ì´ì•¼ê¸°
  goals       String?  // ëª©í‘œ/ë™ê¸°
  conflicts   String?  // ê°ˆë“± ìš”ì†Œ
  avatar      String?  // ì•„ë°”íƒ€ ì´ë¯¸ì§€ ê²½ë¡œ
  color       String   @default("#3b82f6") // ìºë¦­í„° í…Œë§ˆ ìƒ‰ìƒ
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@map("project_characters")
  @@index([projectId])
  @@index([sortOrder])
}

// ğŸ“š í”„ë¡œì íŠ¸ êµ¬ì¡° ëª¨ë¸ - ì±•í„°/ì¥ë©´ ê´€ë¦¬
model ProjectStructure {
  id          String   @id @default(cuid())
  projectId   String
  type        String   // 'chapter' | 'scene' | 'act' | 'section'
  title       String
  description String?
  content     String?  // êµ¬ì¡° ë‚´ìš©/ìš”ì•½
  status      String   @default("planned") // 'planned' | 'in_progress' | 'completed'
  wordCount   Int      @default(0)
  sortOrder   Int      @default(0)
  parentId    String?  // ê³„ì¸µ êµ¬ì¡°ë¥¼ ìœ„í•œ ë¶€ëª¨ ID
  depth       Int      @default(0) // ê³„ì¸µ ê¹Šì´
  color       String   @default("#6b7280") // êµ¬ì¡° ìƒ‰ìƒ
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project  Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent   ProjectStructure?  @relation("StructureHierarchy", fields: [parentId], references: [id])
  children ProjectStructure[] @relation("StructureHierarchy")
  
  @@map("project_structure")
  @@index([projectId])
  @@index([sortOrder])
  @@index([parentId])
}

// ğŸ“‹ í”„ë¡œì íŠ¸ ë©”ëª¨ ëª¨ë¸ - ì‘ê°€ ì•„ì´ë””ì–´/ë©”ëª¨
model ProjectNote {
  id          String   @id @default(cuid())
  projectId   String
  title       String
  content     String
  type        String   @default("general") // 'general' | 'idea' | 'research' | 'plot' | 'dialogue'
  tags        Json?    // íƒœê·¸ ë°°ì—´
  color       String   @default("#fbbf24") // ë©”ëª¨ ìƒ‰ìƒ
  isPinned    Boolean  @default(false)
  isArchived  Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@map("project_notes")
  @@index([projectId])
  @@index([type])
  @@index([isPinned])
  @@index([createdAt])
}

// ğŸ“Š íƒ€ì´í•‘ ì„¸ì…˜ ëª¨ë¸ - í•µì‹¬ ë°ì´í„°
model TypingSession {
  id          String   @id @default(cuid())
  userId      String
  content     String
  startTime   DateTime
  endTime     DateTime?
  keyCount    Int      @default(0)
  wpm         Float    @default(0)
  accuracy    Float    @default(0)
  windowTitle String?
  appName     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyEvents KeyEvent[]
  analytics SessionAnalytics?
  
  @@map("typing_sessions")
  @@index([userId])
  @@index([startTime])
  @@index([wpm])
}

// âŒ¨ï¸ í‚¤ ì´ë²¤íŠ¸ ëª¨ë¸ - ì„¸ë¶€ í‚¤ë³´ë“œ ë°ì´í„°
model KeyEvent {
  id        String   @id @default(cuid())
  sessionId String
  key       String
  keyCode   String
  timestamp DateTime
  eventType String   // 'keydown' | 'keyup'
  createdAt DateTime @default(now())

  // Relations
  session TypingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("key_events")
  @@index([sessionId])
  @@index([timestamp])
}

// ğŸ“ˆ ì„¸ì…˜ ë¶„ì„ ëª¨ë¸ - AI ë¶„ì„ ê²°ê³¼
model SessionAnalytics {
  id                String   @id @default(cuid())
  sessionId         String   @unique
  averageWpm        Float
  peakWpm           Float
  errorCount        Int
  correctionCount   Int
  rhythmScore       Float    // íƒ€ì´í•‘ ë¦¬ë“¬ ì ìˆ˜
  consistencyScore  Float    // ì¼ê´€ì„± ì ìˆ˜
  improvementTips   Json?    // AI ê°œì„  ì œì•ˆ
  analysisData      Json?    // ìƒì„¸ ë¶„ì„ ë°ì´í„°
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  session TypingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("session_analytics")
}

// âš™ï¸ ì‚¬ìš©ì ì„¤ì • ëª¨ë¸
model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  theme                 String   @default("light") // 'light' | 'dark' | 'auto'
  language              String   @default("ko")
  keyboardLayout        String   @default("qwerty")
  showRealTimeWpm       Boolean  @default(true)
  enableSounds          Boolean  @default(false)
  autoSaveInterval      Int      @default(30) // seconds
  privacyMode           Boolean  @default(false)
  monitoringEnabled     Boolean  @default(true)
  targetWpm             Int      @default(60)
  sessionGoalMinutes    Int      @default(30)
  excludedApps          Json?    // ëª¨ë‹ˆí„°ë§ ì œì™¸ ì•± ëª©ë¡
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_settings")
}

// ğŸ† íƒ€ì´í•‘ ì„±ì·¨ ëª¨ë¸
model Achievement {
  id          String   @id @default(cuid())
  userId      String
  type        String   // 'wpm_milestone' | 'session_count' | 'accuracy' etc.
  title       String
  description String
  threshold   Float    // ë‹¬ì„± ê¸°ì¤€ê°’
  earnedAt    DateTime @default(now())
  isActive    Boolean  @default(true)
  
  @@map("achievements")
  @@index([userId])
  @@index([type])
}

// ğŸ“± ì•± ì‚¬ìš© í†µê³„ ëª¨ë¸
model AppUsage {
  id            String   @id @default(cuid())
  userId        String
  appName       String
  windowTitle   String?
  totalTime     Int      // seconds
  sessionCount  Int      @default(1)
  avgWpm        Float    @default(0)
  lastUsed      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("app_usage")
  @@index([userId])
  @@index([appName])
  @@index([lastUsed])
  @@unique([userId, appName])
}

// ğŸ¯ ì¼ì¼ ëª©í‘œ ëª¨ë¸
model DailyGoal {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime
  targetWpm       Int
  targetMinutes   Int
  actualWpm       Float    @default(0)
  actualMinutes   Float    @default(0)
  isCompleted     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("daily_goals")
  @@index([userId])
  @@index([date])
  @@unique([userId, date])
}

// ğŸ” ê²€ìƒ‰ íˆìŠ¤í† ë¦¬ ëª¨ë¸
model SearchHistory {
  id        String   @id @default(cuid())
  userId    String
  query     String
  category  String   // 'sessions' | 'analytics' | 'apps'
  results   Json?    // ê²€ìƒ‰ ê²°ê³¼ ë©”íƒ€ë°ì´í„°
  createdAt DateTime @default(now())
  
  @@map("search_history")
  @@index([userId])
  @@index([createdAt])
}