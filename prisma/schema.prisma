// ğŸ”¥ ê¸°ê°€ì°¨ë“œ Loop Typing Analytics - Prisma Schema
// Loop í”„ë¡œì íŠ¸ì˜ íƒ€ì… ì•ˆì „ì„±ì„ ë³´ì¥í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = "file:./loop.db"
}

// ğŸ¯ ì‚¬ìš©ì ëª¨ë¸ - ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions  TypingSession[]
  settings  UserSettings?
  
  @@map("users")
}

// ğŸ“Š íƒ€ì´í•‘ ì„¸ì…˜ ëª¨ë¸ - í•µì‹¬ ë°ì´í„°
model TypingSession {
  id          String   @id @default(cuid())
  userId      String
  content     String
  startTime   DateTime
  endTime     DateTime?
  keyCount    Int      @default(0)
  wpm         Float    @default(0)
  accuracy    Float    @default(0)
  windowTitle String?
  appName     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  keyEvents KeyEvent[]
  analytics SessionAnalytics?
  
  @@map("typing_sessions")
  @@index([userId])
  @@index([startTime])
  @@index([wpm])
}

// âŒ¨ï¸ í‚¤ ì´ë²¤íŠ¸ ëª¨ë¸ - ì„¸ë¶€ í‚¤ë³´ë“œ ë°ì´í„°
model KeyEvent {
  id        String   @id @default(cuid())
  sessionId String
  key       String
  keyCode   String
  timestamp DateTime
  eventType String   // 'keydown' | 'keyup'
  createdAt DateTime @default(now())

  // Relations
  session TypingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("key_events")
  @@index([sessionId])
  @@index([timestamp])
}

// ğŸ“ˆ ì„¸ì…˜ ë¶„ì„ ëª¨ë¸ - AI ë¶„ì„ ê²°ê³¼
model SessionAnalytics {
  id                String   @id @default(cuid())
  sessionId         String   @unique
  averageWpm        Float
  peakWpm           Float
  errorCount        Int
  correctionCount   Int
  rhythmScore       Float    // íƒ€ì´í•‘ ë¦¬ë“¬ ì ìˆ˜
  consistencyScore  Float    // ì¼ê´€ì„± ì ìˆ˜
  improvementTips   Json?    // AI ê°œì„  ì œì•ˆ
  analysisData      Json?    // ìƒì„¸ ë¶„ì„ ë°ì´í„°
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  session TypingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("session_analytics")
}

// âš™ï¸ ì‚¬ìš©ì ì„¤ì • ëª¨ë¸
model UserSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  theme                 String   @default("light") // 'light' | 'dark' | 'auto'
  language              String   @default("ko")
  keyboardLayout        String   @default("qwerty")
  showRealTimeWpm       Boolean  @default(true)
  enableSounds          Boolean  @default(false)
  autoSaveInterval      Int      @default(30) // seconds
  privacyMode           Boolean  @default(false)
  monitoringEnabled     Boolean  @default(true)
  targetWpm             Int      @default(60)
  sessionGoalMinutes    Int      @default(30)
  excludedApps          Json?    // ëª¨ë‹ˆí„°ë§ ì œì™¸ ì•± ëª©ë¡
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_settings")
}

// ğŸ† íƒ€ì´í•‘ ì„±ì·¨ ëª¨ë¸
model Achievement {
  id          String   @id @default(cuid())
  userId      String
  type        String   // 'wpm_milestone' | 'session_count' | 'accuracy' etc.
  title       String
  description String
  threshold   Float    // ë‹¬ì„± ê¸°ì¤€ê°’
  earnedAt    DateTime @default(now())
  isActive    Boolean  @default(true)
  
  @@map("achievements")
  @@index([userId])
  @@index([type])
}

// ğŸ“± ì•± ì‚¬ìš© í†µê³„ ëª¨ë¸
model AppUsage {
  id            String   @id @default(cuid())
  userId        String
  appName       String
  windowTitle   String?
  totalTime     Int      // seconds
  sessionCount  Int      @default(1)
  avgWpm        Float    @default(0)
  lastUsed      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("app_usage")
  @@index([userId])
  @@index([appName])
  @@index([lastUsed])
  @@unique([userId, appName])
}

// ğŸ¯ ì¼ì¼ ëª©í‘œ ëª¨ë¸
model DailyGoal {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime
  targetWpm       Int
  targetMinutes   Int
  actualWpm       Float    @default(0)
  actualMinutes   Float    @default(0)
  isCompleted     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("daily_goals")
  @@index([userId])
  @@index([date])
  @@unique([userId, date])
}

// ğŸ” ê²€ìƒ‰ íˆìŠ¤í† ë¦¬ ëª¨ë¸
model SearchHistory {
  id        String   @id @default(cuid())
  userId    String
  query     String
  category  String   // 'sessions' | 'analytics' | 'apps'
  results   Json?    // ê²€ìƒ‰ ê²°ê³¼ ë©”íƒ€ë°ì´í„°
  createdAt DateTime @default(now())
  
  @@map("search_history")
  @@index([userId])
  @@index([createdAt])
}