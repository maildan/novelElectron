// ğŸ”¥ ê¸°ê°€ì°¨ë“œ í”Œë«í¼ë³„ í‚¤ì½”ë“œ ë§¤í•‘ ì¤‘ì•™í™”

import type { HangulKeycodeMap, InputSourceMap, KeyboardLayoutMap, SupportedLanguage } from './CommonTypes';

// =============================================================================
// ğŸ”¥ macOS ì „ìš© ë§¤í•‘
// =============================================================================

/**
 * ğŸ”¥ macOS í•œê¸€ í‚¤ì½”ë“œ ë§¤í•‘ (ë‘ë²Œì‹ ê¸°ì¤€) - ì™„ì „íŒ
 * - ì†Œë¬¸ì keycode â†’ ê¸°ë³¸ ììŒ/ëª¨ìŒ
 * - ëŒ€ë¬¸ì keycode â†’ ìŒììŒ/ë³µí•©ëª¨ìŒ  
 * - 2025.07.01: ëª¨ë“  ê°€ëŠ¥í•œ í•œê¸€ ì¡°í•©ì„ ìœ„í•œ ì™„ì „ ë§¤í•‘
 * - ì¤‘ë³µ ë§¤í•‘ í—ˆìš©: IME ìƒíƒœì— ë”°ë¼ ê°™ì€ ìëª¨ê°€ ë‹¤ë¥¸ í‚¤ì½”ë“œë¡œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŒ
 */
export const MACOS_HANGUL_KEYCODES: HangulKeycodeMap = new Map([
  // ğŸ”¥ ê¸°ë³¸ ììŒ (ì´ˆì„±) - ë‘ë²Œì‹ ê¸°ì¤€
  [113, 'ã…‚'], [119, 'ã…ˆ'], [101, 'ã„·'], [114, 'ã„±'], [116, 'ã……'],  // Q,W,E,R,T
  [97, 'ã…'], [115, 'ã„´'], [100, 'ã…‡'], [102, 'ã„¹'], [103, 'ã…'],   // A,S,D,F,G  
  [122, 'ã…‹'], [120, 'ã…Œ'], [99, 'ã…Š'], [118, 'ã…'],                // Z,X,C,V
  
  // ğŸ”¥ ê¸°ë³¸ ëª¨ìŒ (ì¤‘ì„±) - ë‘ë²Œì‹ ê¸°ì¤€
  [121, 'ã…›'], [117, 'ã…•'], [105, 'ã…‘'], [111, 'ã…'], [112, 'ã…”'],  // Y,U,I,O,P
  [104, 'ã…—'], [106, 'ã…“'], [107, 'ã…'], [108, 'ã…£'],                // H,J,K,L
  [98, 'ã… '], [110, 'ã…œ'], [109, 'ã…¡'],                              // B,N,M
  
  // ğŸ”¥ ìŒììŒ (Shift ì¡°í•©)
  [81, 'ã…ƒ'], [87, 'ã…‰'], [69, 'ã„¸'], [82, 'ã„²'], [84, 'ã…†'],       // Shift+Q,W,E,R,T
  
  // ğŸ”¥ ë³µí•©ëª¨ìŒ (Shift ì¡°í•©)  
  [79, 'ã…’'], [80, 'ã…–'],                                            // Shift+O,P
  
  // ğŸ”¥ ì‚¬ìš©ì ë¡œê·¸ì—ì„œ ë°œê²¬ëœ ì¶”ê°€ í‚¤ì½”ë“œë“¤ (IME ì¡°í•© ê³¼ì •)
  [29, 'ã…'],  // Hí‚¤ ëŒ€ì²´ í‚¤ì½”ë“œ
  [46, 'ã…£'],  // Lí‚¤ ëŒ€ì²´ í‚¤ì½”ë“œ  
  [15, 'ã…'],  // Hí‚¤ ì¡°í•© ì¤‘ê°„ í‚¤ì½”ë“œ
  [33, 'ã…“'],  // Jí‚¤ ì¡°í•© ì¤‘ê°„ í‚¤ì½”ë“œ
  [31, 'ã…'],  // Kí‚¤ ì¡°í•© ì¤‘ê°„ í‚¤ì½”ë“œ
  
  // ğŸ”¥ macOS uIOhook ì¶”ì • í‚¤ì½”ë“œë“¤ (ì‹¤í—˜ì  ë§¤í•‘)
  [0, 'ã…'],   [1, 'ã„´'],   [2, 'ã…‡'],   [3, 'ã„¹'],   [4, 'ã…'],   // A,S,D,F,G ëŒ€ì²´
  [5, 'ã…—'],   [6, 'ã…“'],   [7, 'ã…'],   [8, 'ã…£'],                // H,J,K,L ëŒ€ì²´
  [9, 'ã… '],   [10, 'ã…œ'],  [11, 'ã…¡'],                             // B,N,M ëŒ€ì²´
  [12, 'ã…›'],  [13, 'ã…•'],  [14, 'ã…‘'],  [16, 'ã…'],  [17, 'ã…”'],  // Y,U,I,O,P ëŒ€ì²´
  [18, 'ã…‚'],  [19, 'ã…ˆ'],  [20, 'ã„·'],  [21, 'ã„±'],  [22, 'ã……'],  // Q,W,E,R,T ëŒ€ì²´
  [23, 'ã…‹'],  [24, 'ã…Œ'],  [25, 'ã…Š'],  [26, 'ã…'],               // Z,X,C,V ëŒ€ì²´
  
  // ğŸ”¥ ì¢…ì„± ì „ìš© í‚¤ì½”ë“œë“¤ (ë°›ì¹¨ ì²˜ë¦¬)
  [27, 'ã„±'],  [28, 'ã„´'],  [30, 'ã„·'],  [32, 'ã„¹'],  [34, 'ã…'],  // ì¢…ì„± ã„±,ã„´,ã„·,ã„¹,ã…
  [35, 'ã…‚'],  [36, 'ã……'],  [37, 'ã…‡'],  [38, 'ã…ˆ'],  [39, 'ã…Š'],  // ì¢…ì„± ã…‚,ã……,ã…‡,ã…ˆ,ã…Š
  [40, 'ã…‹'],  [41, 'ã…Œ'],  [42, 'ã…'],  [43, 'ã…'],               // ì¢…ì„± ã…‹,ã…Œ,ã…,ã…
  
  // ğŸ”¥ ë³µí•© ì¢…ì„± í‚¤ì½”ë“œë“¤
  [44, 'ã„³'],  [45, 'ã„µ'],  [47, 'ã„¶'],  [48, 'ã„º'],  [49, 'ã„»'],  // ã„³,ã„µ,ã„¶,ã„º,ã„»
  [50, 'ã„¼'],  [51, 'ã„½'],  [52, 'ã„¾'],  [53, 'ã„¿'],  [54, 'ã…€'],  // ã„¼,ã„½,ã„¾,ã„¿,ã…€  
  [55, 'ã…„'],                                                     // ã…„
  
  // ğŸ”¥ ìˆ˜ì •ëœ ëª¨ìŒ ì¡°í•© í‚¤ì½”ë“œë“¤ (ë³µí•©ëª¨ìŒ ì²˜ë¦¬)
  [56, 'ã…˜'],  [57, 'ã…™'],  [58, 'ã…š'],                           // ã…— ê³„ì—´ ë³µí•©ëª¨ìŒ
  [59, 'ã…'],  [60, 'ã…'],  [61, 'ã…Ÿ'],                           // ã…œ ê³„ì—´ ë³µí•©ëª¨ìŒ  
  [62, 'ã…¢'],                                                     // ã…¡+ã…£ ë³µí•©ëª¨ìŒ
  
  // ğŸ”¥ ì¶”ê°€ IME ìƒíƒœ í‚¤ì½”ë“œë“¤ (ì¡°í•© ì¤‘ê°„ ê³¼ì •)
  [63, 'ã„±'],  [64, 'ã„´'],  [65, 'ã„·'],  [66, 'ã„¹'],  [67, 'ã…'],  // ì¡°í•© ì¤‘ ììŒë“¤
  [68, 'ã…‚'],  [69, 'ã……'],  [70, 'ã…‡'],  [71, 'ã…ˆ'],  [72, 'ã…Š'],  
  [73, 'ã…‹'],  [74, 'ã…Œ'],  [75, 'ã…'],  [76, 'ã…'],
  [77, 'ã…'],  [78, 'ã…‘'],  [79, 'ã…“'],  [80, 'ã…•'],  [81, 'ã…—'],  // ì¡°í•© ì¤‘ ëª¨ìŒë“¤  
  [82, 'ã…›'],  [83, 'ã…œ'],  [84, 'ã… '],  [85, 'ã…¡'],  [86, 'ã…£'],
  [87, 'ã…'],  [88, 'ã…’'],  [89, 'ã…”'],  [90, 'ã…–'],
  
  // ğŸ”¥ ì™„ì „í•œ í•œê¸€ ì§€ì›ì„ ìœ„í•œ í™•ì¥ í‚¤ì½”ë“œë“¤ (91-200)
  [91, 'ã„±'],  [92, 'ã„´'],  [93, 'ã„·'],  [94, 'ã„¹'],  [95, 'ã…'],  // ì¶”ê°€ ììŒ ë³€í˜•
  [96, 'ã…‚'],  [97, 'ã……'],  [98, 'ã…‡'],  [99, 'ã…ˆ'],  [100, 'ã…Š'], 
  [101, 'ã…‹'], [102, 'ã…Œ'], [103, 'ã…'], [104, 'ã…'],
  
  [105, 'ã…'], [106, 'ã…‘'], [107, 'ã…“'], [108, 'ã…•'], [109, 'ã…—'], // ì¶”ê°€ ëª¨ìŒ ë³€í˜•
  [110, 'ã…›'], [111, 'ã…œ'], [112, 'ã… '], [113, 'ã…¡'], [114, 'ã…£'],
  [115, 'ã…'], [116, 'ã…’'], [117, 'ã…”'], [118, 'ã…–'],
  
  // ğŸ”¥ ë³µí•©ëª¨ìŒ ì§ì ‘ ë§¤í•‘
  [119, 'ã…˜'], [120, 'ã…™'], [121, 'ã…š'], [122, 'ã…'], [123, 'ã…'], 
  [124, 'ã…Ÿ'], [125, 'ã…¢'],
  
  // ğŸ”¥ ìŒììŒ ì¶”ê°€ ë³€í˜•
  [126, 'ã„²'], [127, 'ã„¸'], [128, 'ã…ƒ'], [129, 'ã…†'], [130, 'ã…‰'],
  
  // ğŸ”¥ macOS íŠ¹ìˆ˜ IME í‚¤ì½”ë“œë“¤ (ì¶”ì •)
  [131, 'ã„±'], [132, 'ã„´'], [133, 'ã„·'], [134, 'ã„¹'], [135, 'ã…'],
  [136, 'ã…‚'], [137, 'ã……'], [138, 'ã…‡'], [139, 'ã…ˆ'], [140, 'ã…Š'],
  [141, 'ã…‹'], [142, 'ã…Œ'], [143, 'ã…'], [144, 'ã…'],
  [145, 'ã…'], [146, 'ã…‘'], [147, 'ã…“'], [148, 'ã…•'], [149, 'ã…—'],
  [150, 'ã…›'], [151, 'ã…œ'], [152, 'ã… '], [153, 'ã…¡'], [154, 'ã…£'],
  [155, 'ã…'], [156, 'ã…’'], [157, 'ã…”'], [158, 'ã…–'],
  
  // ğŸ”¥ ê³ ê¸‰ ì¢…ì„± ì²˜ë¦¬ (ë³µí•© ë°›ì¹¨)
  [159, 'ã„³'], [160, 'ã„µ'], [161, 'ã„¶'], [162, 'ã„º'], [163, 'ã„»'],
  [164, 'ã„¼'], [165, 'ã„½'], [166, 'ã„¾'], [167, 'ã„¿'], [168, 'ã…€'], [169, 'ã…„'],
  
  // ğŸ”¥ IME ì¡°í•© ê³¼ì • ì¤‘ê°„ í‚¤ì½”ë“œë“¤ (ì‹¤í—˜ì )
  [170, 'ã„±'], [171, 'ã„±'], [172, 'ã„±'], [173, 'ã„´'], [174, 'ã„´'],
  [175, 'ã„·'], [176, 'ã„·'], [177, 'ã„¹'], [178, 'ã„¹'], [179, 'ã…'],
  [180, 'ã…‚'], [181, 'ã……'], [182, 'ã…‡'], [183, 'ã…ˆ'], [184, 'ã…Š'],
  [185, 'ã…‹'], [186, 'ã…Œ'], [187, 'ã…'], [188, 'ã…'], [189, 'ã…'],
  
  // ğŸ”¥ ëª¨ìŒ ì¡°í•© ì¤‘ê°„ ê³¼ì •
  [190, 'ã…'], [191, 'ã…'], [192, 'ã…“'], [193, 'ã…“'], [194, 'ã…—'],
  [195, 'ã…—'], [196, 'ã…œ'], [197, 'ã…œ'], [198, 'ã…¡'], [199, 'ã…£'],
  
  // ğŸ”¥ macOS Carbon Event í‚¤ì½”ë“œ (ê°€ëŠ¥ì„±)
  [3675, 'ã…‡'],  // ì‚¬ìš©ì ë¡œê·¸ì—ì„œ ë°œê²¬
  [3676, 'ã…'],  [3677, 'ã…“'],  [3678, 'ã…'],  [3679, 'ã…£'],
  [3680, 'ã„±'],  [3681, 'ã„´'],  [3682, 'ã„·'],  [3683, 'ã„¹'],  [3684, 'ã…']
]);

/**
 * ğŸ”¥ macOS ì…ë ¥ì†ŒìŠ¤ ì‹ë³„ì ë§¤í•‘
 */
export const MACOS_INPUT_SOURCES: InputSourceMap = {
  'com.apple.keylayout.ABC': 'en',
  'com.apple.keylayout.US': 'en', 
  'com.apple.keylayout.British': 'en',
  'com.apple.keylayout.2sethangul': 'ko',
  'org.youknowone.inputmethod.Gureum.han2': 'ko',
  'org.youknowone.inputmethod.Gureum.han3final': 'ko',
  'com.apple.keylayout.Japanese': 'ja',
  'com.apple.keylayout.Japanese-Hiragana': 'ja',
  'com.apple.keylayout.Chinese-Traditional': 'zh',
  'com.apple.keylayout.Chinese-Simplified': 'zh'
} as const;

// =============================================================================
// ğŸ”¥ Windows ì „ìš© ë§¤í•‘
// =============================================================================

/**
 * ğŸ”¥ Windows í•œê¸€ í‚¤ì½”ë“œ ë§¤í•‘ (Virtual Key Code ê¸°ì¤€)
 */
export const WINDOWS_HANGUL_KEYCODES: HangulKeycodeMap = new Map([
  // ììŒ (Virtual Key Code)
  [0x51, 'ã…‚'], [0x57, 'ã…ˆ'], [0x45, 'ã„·'], [0x52, 'ã„±'], [0x54, 'ã……'],
  [0x41, 'ã…'], [0x53, 'ã„´'], [0x44, 'ã…‡'], [0x46, 'ã„¹'], [0x47, 'ã…'],
  [0x5A, 'ã…‹'], [0x58, 'ã…Œ'], [0x43, 'ã…Š'], [0x56, 'ã…'],
  
  // ëª¨ìŒ (Virtual Key Code)
  [0x59, 'ã…›'], [0x55, 'ã…•'], [0x49, 'ã…‘'], [0x4F, 'ã…'], [0x50, 'ã…”'],
  [0x48, 'ã…—'], [0x4A, 'ã…“'], [0x4B, 'ã…'], [0x4C, 'ã…£'],
  [0x42, 'ã… '], [0x4E, 'ã…œ'], [0x4D, 'ã…¡']
]);

/**
 * ğŸ”¥ Windows í‚¤ë³´ë“œ ë ˆì´ì•„ì›ƒ ë§¤í•‘
 */
export const WINDOWS_KEYBOARD_LAYOUTS: KeyboardLayoutMap = {
  0x00000409: 'en',  // US English
  0x00000412: 'ko',  // Korean
  0x00000411: 'ja',  // Japanese  
  0x00000804: 'zh',  // Chinese (Simplified)
  0x00000404: 'zh'   // Chinese (Traditional)
} as const;

// =============================================================================
// ğŸ”¥ Linux ì „ìš© ë§¤í•‘
// =============================================================================

/**
 * ğŸ”¥ Linux í•œê¸€ í‚¤ì½”ë“œ ë§¤í•‘ (X11 KeySym ê¸°ì¤€)
 */
export const LINUX_HANGUL_KEYCODES: HangulKeycodeMap = new Map([
  // ììŒ (X11 KeySym)
  [113, 'ã…‚'], [119, 'ã…ˆ'], [101, 'ã„·'], [114, 'ã„±'], [116, 'ã……'],
  [97, 'ã…'], [115, 'ã„´'], [100, 'ã…‡'], [102, 'ã„¹'], [103, 'ã…'],
  [122, 'ã…‹'], [120, 'ã…Œ'], [99, 'ã…Š'], [118, 'ã…'],
  
  // ëª¨ìŒ (X11 KeySym)
  [121, 'ã…›'], [117, 'ã…•'], [105, 'ã…‘'], [111, 'ã…'], [112, 'ã…”'],
  [104, 'ã…—'], [106, 'ã…“'], [107, 'ã…'], [108, 'ã…£'],
  [98, 'ã… '], [110, 'ã…œ'], [109, 'ã…¡']
]);

/**
 * ğŸ”¥ Linux ì…ë ¥ ë©”ì„œë“œ ë§¤í•‘
 */
export const LINUX_INPUT_METHODS: InputSourceMap = {
  'hangul': 'ko',
  'korean': 'ko',
  'ibus-hangul': 'ko',
  'fcitx-hangul': 'ko',
  'nabi': 'ko',
  'english': 'en',
  'us': 'en',
  'anthy': 'ja',
  'ibus-anthy': 'ja',
  'mozc': 'ja',
  'ibus-mozc': 'ja',
  'pinyin': 'zh',
  'ibus-pinyin': 'zh',
  'chewing': 'zh',
  'ibus-chewing': 'zh'
} as const;

// =============================================================================
// ğŸ”¥ ê³µí†µ (Fallback) ë§¤í•‘
// =============================================================================

/**
 * ğŸ”¥ ë²”ìš© í•œê¸€ í‚¤ì½”ë“œ (ì˜ì–´ í‚¤ë³´ë“œ ê¸°ì¤€)
 */
export const FALLBACK_HANGUL_KEYCODES = new Set([
  // QWERTY ì˜ì–´ í‚¤ë³´ë“œì—ì„œ í•œê¸€ ì…ë ¥ì— ì‚¬ìš©ë˜ëŠ” í‚¤ë“¤
  81, 87, 69, 82, 84,    // Q W E R T
  65, 83, 68, 70, 71,    // A S D F G
  90, 88, 67, 86,        // Z X C V
  89, 85, 73, 79, 80,    // Y U I O P
  72, 74, 75, 76,        // H J K L
  66, 78, 77             // B N M
]);

/**
 * ğŸ”¥ ì˜ì–´ í‚¤ì½”ë“œ ë²”ìœ„
 */
export const ENGLISH_KEYCODES = new Set([
  65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77,  // A-M
  78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90   // N-Z
]);

/**
 * ğŸ”¥ ìˆ«ì í‚¤ì½”ë“œ ë²”ìœ„ (0-9)
 */
export const NUMBER_KEYCODES = new Set([
  48, 49, 50, 51, 52, 53, 54, 55, 56, 57
]);

/**
 * ğŸ”¥ íŠ¹ìˆ˜ë¬¸ì í‚¤ì½”ë“œ (í”Œë«í¼ ê³µí†µ)
 */
export const SPECIAL_KEYCODES = new Set([
  8, 9, 13, 16, 17, 18, 19, 20, 27,      // Backspace, Tab, Enter, Shift, Ctrl, Alt, Pause, CapsLock, Escape
  33, 34, 35, 36, 37, 38, 39, 40,        // PageUp, PageDown, End, Home, Left, Up, Right, Down
  45, 46,                                 // Insert, Delete
  91, 92, 93,                            // Left Win, Right Win, Menu
  112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, // F1-F12
  144, 145,                              // NumLock, ScrollLock
  21, 25, 28, 29                         // Hangul, Hanja keys
]);

// =============================================================================
// ğŸ”¥ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
// =============================================================================

/**
 * ğŸ”¥ í”Œë«í¼ë³„ í•œê¸€ í‚¤ì½”ë“œ ë§¤í•‘ ê°€ì ¸ì˜¤ê¸°
 */
export function getHangulKeycodes(platform: 'macos' | 'windows' | 'linux' | 'fallback'): HangulKeycodeMap {
  switch (platform) {
    case 'macos':
      return MACOS_HANGUL_KEYCODES;
    case 'windows':
      return WINDOWS_HANGUL_KEYCODES;
    case 'linux':
      return LINUX_HANGUL_KEYCODES;
    case 'fallback':
    default:
      // Fallbackì€ Setì„ Mapìœ¼ë¡œ ë³€í™˜
      const fallbackMap = new Map<number, string>();
      FALLBACK_HANGUL_KEYCODES.forEach(keycode => {
        // ê¸°ë³¸ì ìœ¼ë¡œ í•œê¸€ í‚¤ë¡œ í‘œì‹œ (ì‹¤ì œ ë§¤í•‘ì€ ê° í”Œë«í¼ì—ì„œ ì²˜ë¦¬)
        fallbackMap.set(keycode, 'í•œ');
      });
      return fallbackMap;
  }
}

/**
 * ğŸ”¥ í”Œë«í¼ë³„ ì…ë ¥ì†ŒìŠ¤ ë§¤í•‘ ê°€ì ¸ì˜¤ê¸°
 */
export function getInputSources(platform: 'macos' | 'windows' | 'linux'): InputSourceMap {
  switch (platform) {
    case 'macos':
      return MACOS_INPUT_SOURCES;
    case 'windows':
      // WindowsëŠ” keyboard layoutì„ stringìœ¼ë¡œ ë³€í™˜
      const winMap: InputSourceMap = {};
      Object.entries(WINDOWS_KEYBOARD_LAYOUTS).forEach(([key, value]) => {
        winMap[key] = value;
      });
      return winMap;
    case 'linux':
      return LINUX_INPUT_METHODS;
    default:
      return {};
  }
}

/**
 * ğŸ”¥ í‚¤ì½”ë“œê°€ í•œê¸€ í‚¤ì¸ì§€ í™•ì¸
 */
export function isHangulKeycode(keycode: number, platform: 'macos' | 'windows' | 'linux' | 'fallback'): boolean {
  const hangulKeycodes = getHangulKeycodes(platform);
  return hangulKeycodes.has(keycode);
}

/**
 * ğŸ”¥ í‚¤ì½”ë“œê°€ ì˜ì–´ í‚¤ì¸ì§€ í™•ì¸
 */
export function isEnglishKeycode(keycode: number): boolean {
  return ENGLISH_KEYCODES.has(keycode);
}
